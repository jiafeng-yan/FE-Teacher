# 系统架构文档

## 整体架构

本系统采用 **Agentic Workflow** 架构，基于 LangChain 构建，实现了一个完整的教学智能体系统。

```
┌─────────────────────────────────────────────────────────┐
│                     前端界面 (React)                     │
│  - 对话界面                                              │
│  - 文档上传                                              │
│  - 学习进度展示                                          │
└──────────────────┬──────────────────────────────────────┘
                   │ HTTP API
┌──────────────────▼──────────────────────────────────────┐
│              FastAPI 后端服务                            │
│  ┌────────────────────────────────────────────────────┐ │
│  │         核心工作流 (TeachingWorkflow)              │ │
│  │                                                     │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │ │
│  │  │ Planner  │  │   RAG    │  │  Memory  │        │ │
│  │  │ (意图识别)│  │ (知识库) │  │  (记忆)  │        │ │
│  │  └──────────┘  └──────────┘  └──────────┘        │ │
│  │                                                     │ │
│  │  ┌──────────┐                                      │ │
│  │  │  Tools   │                                      │ │
│  │  │ (工具集) │                                      │ │
│  │  └──────────┘                                      │ │
│  └────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

## 核心模块详解

### 1. Planner/Router（意图识别）

**位置**: `backend/modules/planner.py`

**功能**:

- 识别用户意图：学习 (learn)、复习 (review)、答题 (answer)、闲聊 (chat)
- 使用 GPT-3.5-turbo 进行轻量级意图识别
- 返回意图类型、置信度和相关主题

**工作流程**:

```
用户输入 → LLM 分析 → JSON 格式意图结果
```

### 2. RAG 知识库

**位置**: `backend/modules/rag.py`

**功能**:

- 文档上传和向量化存储
- 语义相似度搜索
- 支持多种文档格式（PDF、Word、PPT、TXT）
- **嵌入维度自动检测和修复**（新增）

**技术栈**:

- ChromaDB: 向量数据库
- Sentence Transformers / OpenAI Embeddings: 文本嵌入
- LangChain Document Loaders: 文档加载

**数据流**:

```
文档上传 → 文档解析 → 文本分块 → 向量化 → ChromaDB 存储
查询 → 向量相似度搜索 → 返回相关文档片段
```

**嵌入维度管理**:

系统实现了智能的嵌入维度管理机制，支持无缝切换不同的嵌入模型：

```
重新索引请求
    ↓
检查当前嵌入模型维度
    ↓
尝试添加测试文档到集合
    ↓
┌───┴───┐
│       │
维度匹配  维度不匹配
│       │
↓       ↓
继续索引  删除旧集合
        创建新集合
        使用新维度
        ↓
        继续索引
```

**关键方法**:

- `_check_and_fix_embedding_dimension()`: 自动检测并修复维度不匹配
- `get_embedding_dimension()`: 获取当前嵌入模型的维度
- `reindex_all_documents()`: 重新索引时自动处理维度问题

### 3. Memory（记忆管理）

**位置**: `backend/modules/memory.py`

**功能**:

- **短期记忆**: 对话上下文（使用 ConversationBufferMemory）
- **长期记忆**: 用户学习进度（使用 ChromaDB 持久化）

**数据结构**:

```python
UserProgress {
    user_id: str
    current_topic: str  # 当前学习主题
    mastery_level: Dict[str, float]  # 知识点掌握程度 0-100
    weak_points: List[str]  # 错题记录
    mastered_topics: List[str]  # 已掌握知识点
    last_updated: datetime
}
```

### 4. Tools（工具集）

**位置**: `backend/modules/tools.py`

**可用工具**:

1. **Web Search**: 使用 Tavily API 进行联网搜索

   - 获取最新金融经济新闻和案例
   - 补充知识库中没有的实时信息

2. **Drawing Tool**: 图表生成工具（可扩展）
   - 生成数据可视化图表
   - 辅助教学展示

### 5. Workflow（核心工作流）

**位置**: `backend/modules/workflow.py`

**工作流程**:

```
用户消息
    ↓
意图识别 (Planner)
    ↓
┌───┴───┬───┬───┐
│       │   │   │
learn  review answer chat
│       │   │   │
↓       ↓   ↓   ↓
知识检索 → 生成回复 → 更新记忆
(RAG)   (LLM)   (Memory)
```

**各意图处理逻辑**:

1. **learn（学习）**:

   - 从 RAG 知识库检索相关内容
   - 根据用户进度调整讲解深度
   - 使用苏格拉底式提问引导思考
   - 设置当前学习主题

2. **review（复习）**:

   - 获取用户已学知识点
   - 从知识库检索复习内容
   - 重点关注掌握程度较低的知识点

3. **answer（答题）**:

   - 使用 LLM 判卷评分
   - 更新学习进度数据库
   - 如果得分 < 60，触发"补习模式"
   - 提供详细反馈和正确答案

4. **chat（闲聊）**:
   - 判断是否需要联网搜索
   - 使用工具获取最新信息
   - 进行友好对话

## 数据存储

### ChromaDB 数据库

系统使用两个 ChromaDB 数据库：

1. **知识库数据库** (`./chroma_db`)

   - 存储文档向量嵌入
   - 集合名: `financial_economics_knowledge`
   - 元数据: 文档来源、分块索引
   - **嵌入维度管理**: 集合的嵌入维度在创建时固定，切换模型时系统会自动检测并重建集合

2. **学习进度数据库** (`./learning_progress_db`)
   - 存储用户学习进度
   - 集合名: `user_learning_progress`
   - 数据格式: JSON 序列化的进度对象

### 嵌入维度管理机制

```
┌─────────────────────────────────────────────────┐
│         嵌入模型切换流程                          │
└─────────────────────────────────────────────────┘

1. 用户切换嵌入模型（修改配置）
   ↓
2. 系统启动时初始化新嵌入模型
   ↓
3. 用户执行重新索引操作
   ↓
4. 系统检测嵌入维度
   ├─ 维度匹配 → 直接重新索引
   └─ 维度不匹配 → 自动修复流程
       ├─ 保存现有文档元数据
       ├─ 删除旧集合
       ├─ 创建新集合（使用新维度）
       └─ 使用保存的元数据重新索引
   ↓
5. 重新索引完成，所有文档使用新模型
```

## API 接口

### 主要端点

- `POST /api/chat`: 对话接口
- `POST /api/upload`: 文档上传
- `GET /api/progress/{user_id}`: 获取学习进度
- `POST /api/progress/{user_id}`: 更新学习进度
- `GET /api/knowledge/info`: 知识库信息
- `POST /api/knowledge/search`: 搜索知识库

## 前端架构

### 技术栈

- React 18
- Vite (构建工具)
- Tailwind CSS (样式)
- Axios (HTTP 客户端)

### 组件结构

```
App.jsx
├── ChatInterface.jsx (对话界面)
├── DocumentUpload.jsx (文档上传)
└── ProgressView (学习进度展示)
```

## 配置管理

所有配置通过环境变量管理（`.env` 文件）：

- **OpenAI 配置**: API Key、模型选择
- **嵌入模型**: 本地模型 vs OpenAI 模型
- **数据库路径**: ChromaDB 存储位置
- **服务器配置**: 端口、主机地址
- **工具配置**: Tavily API Key 等

## 扩展点

### 1. 添加新工具

在 `backend/modules/tools.py` 中添加新工具函数，并在 `get_tools()` 中注册。

### 2. 自定义教学策略

修改 `backend/modules/workflow.py` 中各意图处理函数中的提示词。

### 3. 调整评分算法

修改 `_handle_answer_intent` 方法中的评分逻辑和阈值。

### 4. 优化检索策略

在 `backend/modules/rag.py` 中实现更复杂的检索逻辑（如混合检索、重排序等）。

## 性能优化建议

1. **嵌入模型**: 使用本地模型可减少 API 调用成本
2. **向量检索**: 调整 `k` 值平衡准确性和速度
3. **对话记忆**: 考虑限制对话历史长度，避免上下文过长
4. **文档分块**: 根据文档类型调整分块策略

## 安全考虑

1. **API 密钥**: 使用环境变量，不要提交到代码仓库
2. **文件上传**: 限制文件类型和大小
3. **用户数据**: 学习进度数据本地存储，注意隐私保护
4. **CORS**: 配置允许的前端域名
