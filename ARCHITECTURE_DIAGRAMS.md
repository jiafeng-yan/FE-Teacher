# 系统架构图示文档

本文档包含系统的详细架构图、流程图和数据流图。

## 1. 系统整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (React)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 对话界面      │  │ 文档上传      │  │ 设置管理      │         │
│  │ ChatInterface│  │DocumentUpload │  │ChunkSettings │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└───────────────────────────┬───────────────────────────────────┘
                            │ HTTP/REST API
┌───────────────────────────▼───────────────────────────────────┐
│                    FastAPI 后端服务层                            │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │              API 路由层 (main.py)                         │ │
│  │  /api/chat  /api/upload  /api/knowledge/*  /api/progress  │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │          核心工作流层 (TeachingWorkflow)                  │ │
│  │                                                           │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │ │
│  │  │  Planner   │  │    RAG     │  │  Memory    │        │ │
│  │  │ 意图识别    │  │  知识库    │  │  记忆管理   │        │ │
│  │  └────────────┘  └────────────┘  └────────────┘        │ │
│  │                                                           │ │
│  │  ┌────────────┐                                         │ │
│  │  │   Tools    │                                         │ │
│  │  │  工具集     │                                         │ │
│  │  └────────────┘                                         │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │              工具层 (Utils)                                │ │
│  │  DocumentLoader  EmbeddingManager                        │ │
│  └──────────────────────────────────────────────────────────┘ │
└───────────────────────────┬───────────────────────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────────┐
│                      数据存储层                                 │
│  ┌──────────────────────┐  ┌──────────────────────┐          │
│  │   ChromaDB           │  │   ChromaDB           │          │
│  │   知识库数据库        │  │   学习进度数据库      │          │
│  │   (向量存储)          │  │   (用户进度)          │          │
│  └──────────────────────┘  └──────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────────┐
│                      外部服务层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  OpenAI API  │  │ Tavily API   │  │ 本地嵌入模型  │        │
│  │  (LLM)       │  │ (搜索)       │  │ (Embeddings) │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 核心工作流流程图

```
                    ┌─────────────┐
                    │  用户输入    │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ 意图识别     │
                    │  (Planner)  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
   ┌────────┐        ┌────────┐        ┌────────┐
   │ learn  │        │review │        │answer  │
   │ 学习   │        │ 复习   │        │ 答题   │
   └───┬────┘        └───┬────┘        └───┬────┘
       │                 │                 │
       │                 │                 │
       ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ RAG 检索    │   │ RAG 检索    │   │ LLM 判卷    │
│ 相关知识    │   │ 复习内容    │   │ 评分        │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       │                 │                 │
       ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ 生成个性化  │   │ 生成复习    │   │ 更新学习    │
│ 教学内容    │   │ 材料        │   │ 进度        │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
                         ▼
                  ┌─────────────┐
                  │ 更新记忆    │
                  │  (Memory)  │
                  └──────┬──────┘
                         │
                         ▼
                  ┌─────────────┐
                  │ 返回回复    │
                  └─────────────┘
```

## 3. RAG 知识库数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                    文档上传流程                               │
└─────────────────────────────────────────────────────────────┘

用户上传文档
    │
    ▼
┌─────────────┐
│ 文档解析     │  (PDF/Word/PPT/TXT)
│DocumentLoader│
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 文本分块     │  (chunk_size, chunk_overlap)
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 向量化       │  (EmbeddingManager)
│ 生成嵌入     │
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 存储到       │
│ ChromaDB    │  (向量 + 元数据)
└─────────────┘


┌─────────────────────────────────────────────────────────────┐
│                    知识检索流程                               │
└─────────────────────────────────────────────────────────────┘

用户查询
    │
    ▼
┌─────────────┐
│ 查询向量化   │  (EmbeddingManager.embed_query)
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 向量相似度   │
│ 搜索        │  (ChromaDB similarity_search)
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 返回 Top-K   │
│ 相关文档片段 │
└─────────────┘
```

## 4. 嵌入维度管理流程图

```
┌─────────────────────────────────────────────────────────────┐
│              嵌入模型切换和维度修复流程                        │
└─────────────────────────────────────────────────────────────┘

用户切换嵌入模型
    │
    ▼
┌─────────────┐
│ 修改配置     │  (.env 文件)
│ 重启服务     │
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 初始化新     │
│ 嵌入模型     │  (EmbeddingManager)
└──────┬───────┘
       │
       ▼
用户执行重新索引
    │
    ▼
┌─────────────┐
│ 保存现有     │
│ 文档元数据   │
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 获取当前     │
│ 嵌入维度     │  (get_embedding_dimension)
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 尝试添加     │
│ 测试文档     │  (检测维度匹配)
└──────┬───────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌─────────────┐   ┌─────────────┐
│ 维度匹配     │   │ 维度不匹配   │
└──────┬───────┘   └──────┬──────┘
       │                 │
       │                 ▼
       │         ┌─────────────┐
       │         │ 删除旧集合   │
       │         └──────┬──────┘
       │                │
       │                ▼
       │         ┌─────────────┐
       │         │ 创建新集合   │
       │         │ (使用新维度) │
       │         └──────┬──────┘
       │                │
       └────────────────┘
                │
                ▼
        ┌─────────────┐
        │ 使用保存的   │
        │ 元数据重新   │
        │ 索引所有文档 │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │ 重新索引完成 │
        └─────────────┘
```

## 5. 记忆管理架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      记忆系统架构                              │
└─────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │  记忆管理器   │
                    │ MemoryManager│
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ 短期记忆     │   │ 长期记忆     │   │ 对话上下文   │
│             │   │             │   │             │
│ LLM 内置    │   │ ChromaDB    │   │ BufferMemory│
│ 上下文窗口   │   │ 持久化存储   │   │             │
│             │   │             │   │             │
│ - 当前对话  │   │ - 学习进度   │   │ - 历史消息  │
│ - 临时状态  │   │ - 知识点掌握 │   │ - 上下文    │
│             │   │ - 错题记录  │   │             │
└─────────────┘   └─────────────┘   └─────────────┘
```

## 6. 数据存储结构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ChromaDB 知识库数据库                      │
│                    (./chroma_db)                             │
└─────────────────────────────────────────────────────────────┘

Collection: financial_economics_knowledge
├── 向量嵌入 (embeddings)
│   └── 维度: 384/768/1536/3072 (取决于嵌入模型)
│
├── 文档内容 (documents)
│   └── 文本块内容
│
└── 元数据 (metadatas)
    ├── source: 文件名
    ├── chunk_index: 分块索引
    └── file_path: 文件路径


┌─────────────────────────────────────────────────────────────┐
│                  ChromaDB 学习进度数据库                      │
│                  (./learning_progress_db)                     │
└─────────────────────────────────────────────────────────────┘

Collection: user_learning_progress
├── 用户ID (ids)
│   └── user_id
│
├── 文档内容 (documents)
│   └── JSON 序列化的进度对象
│
└── 元数据 (metadatas)
    └── last_updated: 最后更新时间

进度对象结构:
{
    "user_id": "user123",
    "current_topic": "GDP",
    "mastery_level": {
        "GDP": 75.0,
        "通货膨胀": 60.0
    },
    "weak_points": ["货币政策"],
    "mastered_topics": ["基础概念"],
    "last_updated": "2024-01-01T00:00:00"
}
```

## 7. API 接口架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      API 接口层                               │
└─────────────────────────────────────────────────────────────┘

POST /api/chat
    │
    └──> TeachingWorkflow.process_message()
            │
            ├──> Planner.identify_intent()
            ├──> RAG.search()
            ├──> Memory.get_user_progress()
            └──> Memory.update_progress()

POST /api/upload
    │
    └──> RAGKnowledgeBase.add_document_from_file()
            │
            ├──> DocumentLoader.load_document()
            ├──> EmbeddingManager.embed_documents()
            └──> ChromaDB.add()

POST /api/knowledge/reindex
    │
    └──> RAGKnowledgeBase.reindex_all_documents()
            │
            ├──> _check_and_fix_embedding_dimension()
            │       │
            │       ├──> get_embedding_dimension()
            │       ├──> 检测维度匹配
            │       └──> 修复维度不匹配（如需要）
            │
            ├──> DocumentLoader.load_document()
            ├──> delete_by_source()
            └──> add_documents()

GET /api/progress/{user_id}
    │
    └──> LearningProgressDB.get_user_progress()

POST /api/progress/{user_id}
    │
    └──> LearningProgressDB.update_user_progress()
```

## 8. 组件交互序列图

```
用户          前端          后端API        工作流        RAG         ChromaDB
 │            │            │            │            │            │
 │──上传文档──>│            │            │            │            │
 │            │──POST /api/upload──>│            │            │            │
 │            │            │──add_document──>│            │            │
 │            │            │            │──load_doc──>│            │
 │            │            │            │            │──embed──>│
 │            │            │            │            │──add──>│──存储──>│
 │            │<──响应─────│<──返回──────│<──完成──────│<──完成──────│
 │<──成功──────│            │            │            │            │
 │            │            │            │            │            │
 │──提问──────>│            │            │            │            │
 │            │──POST /api/chat──>│            │            │            │
 │            │            │──process_message──>│            │            │
 │            │            │            │──identify_intent──>│            │
 │            │            │            │<──意图──────│            │
 │            │            │            │──search──>│            │
 │            │            │            │            │──query──>│──检索──>│
 │            │            │            │            │<──结果──────│<──文档──>│
 │            │            │            │──generate──>│            │            │
 │            │            │            │<──回复──────│            │            │
 │            │<──响应─────│<──返回──────│            │            │            │
 │<──回复──────│            │            │            │            │            │
```

## 9. 错误处理和恢复机制

```
┌─────────────────────────────────────────────────────────────┐
│              嵌入维度不匹配错误处理流程                         │
└─────────────────────────────────────────────────────────────┘

重新索引操作
    │
    ▼
┌─────────────┐
│ 保存文档     │
│ 元数据       │
└──────┬───────┘
       │
       ▼
┌─────────────┐
│ 检测嵌入     │
│ 维度        │
└──────┬───────┘
       │
       ├─── 维度匹配 ───> 继续索引
       │
       └─── 维度不匹配
              │
              ▼
       ┌─────────────┐
       │ 捕获异常     │
       │ (dimension  │
       │  error)     │
       └──────┬───────┘
              │
              ▼
       ┌─────────────┐
       │ 删除旧集合   │
       └──────┬───────┘
              │
              ▼
       ┌─────────────┐
       │ 创建新集合   │
       │ (新维度)     │
       └──────┬───────┘
              │
              ▼
       ┌─────────────┐
       │ 使用保存的   │
       │ 元数据重新   │
       │ 索引         │
       └──────┬───────┘
              │
              ▼
       ┌─────────────┐
       │ 索引完成     │
       └─────────────┘
```

## 10. 配置管理层次图

```
┌─────────────────────────────────────────────────────────────┐
│                      配置层次结构                              │
└─────────────────────────────────────────────────────────────┘

环境变量 (.env)
    │
    ├──> OpenAI 配置
    │     ├── OPENAI_API_KEY
    │     ├── OPENAI_MODEL
    │     └── OPENAI_BASE_URL
    │
    ├──> 嵌入模型配置
    │     ├── USE_LOCAL_EMBEDDING
    │     ├── LOCAL_EMBEDDING_MODEL
    │     └── OPENAI_EMBEDDING_MODEL
    │
    ├──> 意图识别配置
    │     ├── INTENT_MODEL_API_KEY
    │     ├── INTENT_MODEL_NAME
    │     └── INTENT_MODEL_BASE_URL
    │
    ├──> 数据库配置
    │     ├── CHROMA_DB_PATH
    │     └── CHROMA_COLLECTION_NAME
    │
    └──> 文档分片配置
          ├── DEFAULT_CHUNK_SIZE
          └── DEFAULT_CHUNK_OVERLAP
                │
                ▼
          Settings 类 (config.py)
                │
                ▼
          应用代码使用
```

---

## 图示说明

以上图示展示了系统的完整架构和关键流程：

1. **系统整体架构图**：展示了从前端到数据存储的完整层次结构
2. **核心工作流流程图**：展示了用户消息处理的完整流程
3. **RAG 知识库数据流图**：展示了文档上传和检索的数据流
4. **嵌入维度管理流程图**：展示了模型切换和维度修复的详细流程
5. **记忆管理架构图**：展示了短期和长期记忆的组织结构
6. **数据存储结构图**：展示了 ChromaDB 的数据组织方式
7. **API 接口架构图**：展示了主要 API 的调用关系
8. **组件交互序列图**：展示了用户操作时的组件交互时序
9. **错误处理和恢复机制**：展示了维度不匹配错误的处理流程
10. **配置管理层次图**：展示了配置的层次结构和管理方式

这些图示可以帮助开发者快速理解系统架构和关键流程。
